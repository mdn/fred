name: NPM Publish simulation

on:
  pull_request:

# No GITHUB_TOKEN permissions, as we only use it to increase API limit.
permissions: {}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: (mdn/fred) Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: mdn/fred
          persist-credentials: false

      - name: (mdn/fred) Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version-file: mdn/fred/.nvmrc
          cache: npm
          cache-dependency-path: mdn/fred/package-lock.json

      - name: (mdn/fred) Install all npm packages
        working-directory: mdn/fred
        run: npm ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: (mdn/fred) Build tarball
        id: build
        working-directory: mdn/fred
        run: |
          npm pack
          TARBALL=`ls mdn-fred-*.tgz`
          echo $TARBALL
          ls -lh $TARBALL
          echo "tarball=$TARBALL" >> "$GITHUB_OUTPUT"

      - name: (mdn/fred) archive tarball
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: tarball
          path: mdn/fred/${{ steps.build.outputs.tarball }}
          compression-level: 0 # file already compressed

  test:
    needs: build
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
    runs-on: ${{ matrix.os }}

    steps:
      - name: (mdn/content) Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          repository: mdn/content
          path: mdn/content
          persist-credentials: false

      - name: (mdn/content) Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version-file: mdn/content/.nvmrc
          cache: yarn
          cache-dependency-path: mdn/content/yarn.lock

      - name: (mdn/content) Download tarball
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: tarball

      - name: (mdn/content) Install tarball
        working-directory: mdn/content
        shell: bash
        run: |
          yarn cache clean --all
          TARBALL=$(ls ../../mdn-fred-*.tgz)
          yarn add file:$TARBALL
          yarn install
        env:
          # Increase GitHub API limit.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: (mdn/content) yarn fred-ssr (Linux)
        if: runner.os == 'Linux'
        working-directory: mdn/content
        run: yarn fred-ssr

      - name: (mdn/fred) Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          path: mdn/fred
          persist-credentials: false

      - name: (mdn/fred) Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version-file: mdn/fred/.nvmrc
          cache: npm
          cache-dependency-path: mdn/fred/package-lock.json

      - name: (mdn/fred) Install all npm packages
        working-directory: mdn/fred
        run: npm ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: (mdn/fred) Run tests
        id: build
        working-directory: mdn/fred
        env:
          FRED_PORT: 5042
          CONTENT_REPO_ROOT: ../content
          # Increase GitHub API limit.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/npm-test.js
