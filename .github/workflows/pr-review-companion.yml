name: PR review companion

on:
  pull_request:
    branches:
      - main

  workflow_call:
    secrets:
      GCP_PROJECT_NAME:
        required: true
      WIP_PROJECT_ID:
        required: true

permissions:
  # Post comment in pull request.
  pull-requests: write
  # Authenticate with GCP.
  id-token: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  PREFIX: fred-pr${{ github.event.pull_request.number }}
  HOST: "review.mdn.allizom.net"

jobs:
  deploy:
    if: github.repository_owner == 'mdn' && github.event.pull_request.user.login != 'dependabot[bot]'
    environment:
      name: review
      url: https://${{ env.PREFIX }}.${{ env.HOST }}
    runs-on: ubuntu-latest
    env:
      BUILD_OUT_ROOT: ${{ github.workspace }}/mdn/fred/out

    steps:
      - name: Stop if author/actor is not an admin
        env:
          ACTOR: ${{ github.actor }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # Check author.
          AUTHOR_PERMISSION=$(gh api https://api.github.com/repos/$REPO/collaborators/$AUTHOR/permission --jq .permission)

          if [ "$AUTHOR_PERMISSION" != "admin" ]; then
              echo "PR author ($AUTHOR) is not an admin, please ping someone for a review."
              gh run cancel --repo "$REPO" $RUN_ID
              exit 1
          fi

          # Check actor.
          if [ "$ACTOR" != "$AUTHOR" ]; then
              ACTOR_PERMISSION=$(gh api https://api.github.com/repos/$REPO/collaborators/$ACTOR/permission --jq .permission)

              if [ "$ACTOR_PERMISSION" != "admin" ]; then
                  echo "PR actor ($ACTOR) is not an admin, please ping someone for a review."
                  gh run cancel --repo "$REPO" $RUN_ID
                  exit 1
              fi
          fi

      - name: Checkout (fred)
        uses: actions/checkout@v4
        with:
          path: mdn/fred

      - name: Checkout (content)
        uses: actions/checkout@v4
        with:
          repository: mdn/content
          path: mdn/content

      - name: Checkout (curriculum)
        uses: actions/checkout@v4
        with:
          repository: mdn/curriculum
          path: mdn/curriculum

      - name: Checkout (mdn-studio)
        uses: actions/checkout@v4
        with:
          repository: mdn/mdn-studio
          path: mdn/mdn-studio
          lfs: true
          token: ${{ secrets.MDN_STUDIO_PAT }}

      - name: Checkout (generic-content)
        uses: actions/checkout@v4
        with:
          repository: mdn/generic-content
          path: mdn/generic-content

      - name: Checkout (mdn-contributor-spotlight)
        uses: actions/checkout@v4
        with:
          repository: mdn/mdn-contributor-spotlight
          path: mdn/mdn-contributor-spotlight

      - name: Setup (fred)
        uses: actions/setup-node@v4
        with:
          node-version-file: "mdn/fred/.nvmrc"
          cache: npm
          cache-dependency-path: "mdn/fred/package-lock.json"

      - name: Install (fred)
        working-directory: mdn/fred
        run: npm ci

      - name: Build (fred)
        working-directory: mdn/fred
        run: npm run build

      - name: Build (rari)
        working-directory: mdn/fred
        env:
          CONTENT_ROOT: ${{ github.workspace }}/mdn/content/files
          CONTRIBUTOR_SPOTLIGHT_ROOT: ${{ github.workspace }}/mdn/mdn-contributor-spotlight/contributors
          BLOG_ROOT: ${{ github.workspace }}/mdn/mdn-studio/content/posts
          CURRICULUM_ROOT: ${{ github.workspace }}/mdn/curriculum
          GENERIC_CONTENT_ROOT: ${{ github.workspace }}/mdn/generic-content/files

          LIVE_SAMPLES_BASE_URL: https://live.mdnyalp.dev
          INTERACTIVE_EXAMPLES_BASE_URL: https://interactive-examples.mdn.allizom.net

          ADDITIONAL_LOCALES_FOR_GENERICS_AND_SPAS: de
        run: |
          set -eo pipefail

          npm run rari git-history

          # Only build some content pages.
          find $CONTENT_ROOT -name 'index.md' -type f -maxdepth 4 > ${{ github.workspace }}/files.txt

          npm run rari build -- --all --file-list ${{ github.workspace }}/files.txt --templ-stats

      - name: Render (fred)
        working-directory: mdn/fred
        run: |
          npm run ssr

          cp -r dist $BUILD_OUT_ROOT/static

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          service_account: deploy-mdn-review-content@${{ secrets.GCP_PROJECT_NAME }}.iam.gserviceaccount.com
          workload_identity_provider: projects/${{ secrets.WIP_PROJECT_ID }}/locations/global/workloadIdentityPools/github-actions/providers/github-actions

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload to GCS
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: ${{ env.BUILD_OUT_ROOT }}
          destination: "${{ vars.GCP_BUCKET_NAME }}/${{ env.PREFIX }}"
          resumable: false
          concurrency: 500
          parent: false
          process_gcloudignore: false

      - name: Post message in PR
        run: |
          COMMENT_ID=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --comments --json comments \
            --jq ".comments | sort_by(.createdAt) | map(select(.author.login == \"github-actions\")) | .[0].id")

          if [ -n "$COMMENT_ID" ]; then
            gh api graphql -f query='
                mutation($id:ID!, $body:String!) {
                updateIssueComment(input:{id:$id, body:$body}) {
                    issueComment {
                        id
                    }
                }
            }' -f id="$COMMENT_ID" -f body="$BODY"
          else
            gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "$BODY"
          fi
        env:
          BODY: "${{ github.sha }} was deployed to: https://${{ env.PREFIX }}.${{ env.HOST }}/"
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
