name: PR review companion

on:
  pull_request:
    branches:
      - main

  workflow_call:
    secrets:
      GCP_PROJECT_NAME:
        required: true
      WIP_PROJECT_ID:
        required: true

permissions:
  # Download artifact.
  actions: read
  # Post comment in pull request.
  pull-requests: write
  # Authenticate with GCP.
  id-token: write

jobs:
  check:
    if: github.repository_owner == 'mdn' && github.event.pull_request.user.login != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Check if author/actor is not an admin
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check author.
          AUTHOR="${{ github.event.pull_request.user.login }}"
          AUTHOR_PERMISSION=$(gh api https://api.github.com/repos/${{ github.repository }}/collaborators/$AUTHOR/permission --jq .permission)

          if [ "$AUTHOR_PERMISSION" != "admin" ]; then
              echo "PR author ($AUTHOR) is not an admin, please ping someone for a review."
              exit 1
          fi

          # Check actor.
          ACTOR="${{ github.actor }}"
          if [ "$ACTOR" != "$AUTHOR" ]; then
              ACTOR_PERMISSION=$(gh api https://api.github.com/repos/${{ github.repository }}/collaborators/$ACTOR/permission --jq .permission)

              if [ "$ACTOR_PERMISSION" != "admin" ]; then
                  echo "PR actor ($ACTOR) is not an admin, please ping someone for a review."
                  exit 1
              fi
          fi

  build:
    runs-on: ubuntu-latest
    needs:
      - check
    env:
      BUILD_OUT_ROOT: ${{ github.workspace }}/mdn/fred/out

    steps:
      - name: Checkout (fred)
        uses: actions/checkout@v4
        with:
          path: mdn/fred

      - name: Checkout (content)
        uses: actions/checkout@v4
        with:
          repository: mdn/content
          path: mdn/content

      - name: Checkout (curriculum)
        uses: actions/checkout@v4
        with:
          repository: mdn/curriculum
          path: mdn/curriculum

      - name: Checkout (mdn-studio)
        uses: actions/checkout@v4
        with:
          repository: mdn/mdn-studio
          path: mdn/mdn-studio
          lfs: true
          token: ${{ secrets.MDN_STUDIO_PAT }}

      - name: Checkout (generic-content)
        uses: actions/checkout@v4
        with:
          repository: mdn/generic-content
          path: mdn/generic-content

      - name: Checkout (mdn-contributor-spotlight)
        uses: actions/checkout@v4
        with:
          repository: mdn/mdn-contributor-spotlight
          path: mdn/mdn-contributor-spotlight

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: "mdn/fred/.nvmrc"

      - name: Build some pages
        working-directory: mdn/fred
        env:
          CONTENT_ROOT: ${{ github.workspace }}/mdn/content/files
          CONTRIBUTOR_SPOTLIGHT_ROOT: ${{ github.workspace }}/mdn/mdn-contributor-spotlight/contributors
          BLOG_ROOT: ${{ github.workspace }}/mdn/mdn-studio/content/posts
          CURRICULUM_ROOT: ${{ github.workspace }}/mdn/curriculum
          GENERIC_CONTENT_ROOT: ${{ github.workspace }}/mdn/generic-content/files

          # rari
          LIVE_SAMPLES_BASE_URL: https://live.test.mdnyalp.dev
          INTERACTIVE_EXAMPLES_BASE_URL: https://interactive-examples.mdn.allizom.net
          ADDITIONAL_LOCALES_FOR_GENERICS_AND_SPAS: de

          BUILD_LIVE_SAMPLES_BASE_URL: https://live.mdnyalp.dev
          BUILD_LEGACY_LIVE_SAMPLES_BASE_URL: https://live.mdnyalp.dev

          # Use the stage version of interactive examples.
          BUILD_INTERACTIVE_EXAMPLES_BASE_URL: https://interactive-examples.mdn.allizom.net

          # Now is not the time to worry about flaws.
          BUILD_FLAW_LEVELS: "*:ignore"

          # This adds the ability to sign in (stage only for now)
          REACT_APP_DISABLE_AUTH: true

          # Playground
          REACT_APP_PLAYGROUND_BASE_HOST: mdnyalp.dev
        run: |
          set -eo pipefail

          # Info about which CONTENT_* environment variables were set and to what.
          echo "CONTENT_ROOT=$CONTENT_ROOT"
          echo "BLOG_ROOT=$BLOG_ROOT"

          npm ci
          mkdir -p $BUILD_OUT_ROOT/static

          npm run rari git-history

          # Only build some content pages.
          find $CONTENT_ROOT -name 'index.md' -type f -maxdepth 4 > ${{ github.workspace }}/files.txt

          npm run rari build -- --file-list ${{ github.workspace }}/files.txt --spas --blog --curriculum --generics --templ-stats

          # SSR all pages
          npm run build
          node build/ssr.js
          cp -r dist/* $BUILD_OUT_ROOT/static/

          echo ${{ github.event.number }} > ${BUILD_OUT_ROOT}/NR

      - uses: actions/upload-artifact@v4
        with:
          name: build
          path: ${{ env.BUILD_OUT_ROOT }}

  deploy:
    environment: review
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - name: "Download artifact"
        uses: actions/download-artifact@v4
        with:
          pattern: build
          path: build
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for artifacts
        id: check
        if: hashFiles('build/') != ''
        run: |
          echo "HAS_ARTIFACT=true" >> "$GITHUB_OUTPUT"
          PR_NUMBER=`cat build/NR | tr -dc '0-9'`
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "PREFIX=fred-$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Authenticate with GCP
        if: steps.check.outputs.HAS_ARTIFACT
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          service_account: deploy-mdn-review-content@${{ secrets.GCP_PROJECT_NAME }}.iam.gserviceaccount.com
          workload_identity_provider: projects/${{ secrets.WIP_PROJECT_ID }}/locations/global/workloadIdentityPools/github-actions/providers/github-actions

      - name: Setup gcloud
        if: steps.check.outputs.HAS_ARTIFACT
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload to GCS
        if: steps.check.outputs.HAS_ARTIFACT
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: "build"
          destination: "${{ vars.GCP_BUCKET_NAME }}/${{ steps.check.outputs.PREFIX }}"
          resumable: false
          concurrency: 500
          parent: false
          process_gcloudignore: false

      - name: Post message in PR
        if: steps.check.outputs.HAS_ARTIFACT
        run: |
          COMMENT_ID=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --comments --json comments \
            --jq ".comments | sort_by(.createdAt) | map(select(.author.login == \"github-actions\")) | .[0].id")

          if [ -n "$COMMENT_ID" ]; then
            gh api graphql -f query='
                mutation($id:ID!, $body:String!) {
                updateIssueComment(input:{id:$id, body:$body}) {
                    issueComment {
                        id
                    }
                }
            }' -f id="$COMMENT_ID" -f body="$BODY"
          else
            gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body "$BODY"
          fi
        env:
          BODY: "Review deployment: https://${{ steps.check.outputs.PREFIX }}.review.mdn.allizom.net/"
          PR_NUMBER: ${{ steps.check.outputs.PR_NUMBER }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
