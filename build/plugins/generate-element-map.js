import fs from "node:fs/promises";
import path from "node:path";

import { fdir } from "fdir";

import { toPascalCase } from "../utils.js";

/**
 * @import { Compiler } from "@rspack/core"
 */

export class GenerateElementMapPlugin {
  /**
   * @param {Compiler} compiler
   */
  apply(compiler) {
    compiler.hooks.beforeCompile.tapPromise(
      "GenerateElementMapPlugin",
      async () => {
        const api = new fdir()
          .withFullPaths()
          .filter((filePath) => filePath.endsWith("/element.js"))
          .crawl(path.join(compiler.context, "components"));
        const files = await api.withPromise();

        const mapping = files.map((filePath) => {
          const relPath =
            ".." + filePath.replace(compiler.context, "").replaceAll("\\", "/");
          const folderName = relPath.split("/").at(-2);
          const tagName = `mdn-${folderName}`;
          const className = toPascalCase(tagName);
          return `"${tagName}": import("${relPath}").${className};`;
        });

        const content = `// WARNING: do not edit this file, it's automatically generated by GenerateElementMapPlugin

declare global {
  interface HTMLElementTagNameMap {
    ${mapping.toSorted().join(`
    `)}
  }
}

export {};
`;

        const outPath = path.resolve(
          compiler.context,
          "types",
          "element-map.d.ts",
        );
        fs.writeFile(outPath, content);
      },
    );
  }
}
